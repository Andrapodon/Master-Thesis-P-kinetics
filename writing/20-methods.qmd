# Materials and Methods

## The Long-Term Phosphorus Fertilization Experiment

The soil samples for this thesis originate from a set of six long-term field trials in Switzerland, established by Agroscope between 1989 and 1992. The primary objective of these experiments was to validate and re-evaluate Swiss phosphorus (P) fertilization guidelines by assessing long-term crop yield responses to varying P inputs across different pedoclimatic conditions. A detailed description of the experimental design and site characteristics can be found in Hirte et al. (2021).

The experiment was set up as a **completely randomized block design** with four field replications at each site. The core of the experiment consists of six fixed-plot treatments representing different P fertilization levels, which were applied annually as superphosphate before tillage and sowing. These levels were based on percentages of the officially recommended P inputs: 0% (Zero), 33% (Deficit), 67% (Reduced), 100% (Norm), 133% (Elevated), and 167% (Surplus).

## Experimental Sites

The six experimental sites are located in the main crop-growing regions of Switzerland: **Rümlang-Altwi (ALT)**, **Cadenazzo (CAD)**, **Ellighausen (ELL)**, **Grabs (GRA)**, **Oensingen (OEN)**, and **Zurich-Reckenholz (REC)**. The key soil properties are summarized below.

```{r}
#| label: tbl-sites-corrected
#| tbl-cap: "Soil characteristics of the six long-term experimental sites. Data adapted from Hirte et al. (2021)."

sites_df_corrected <- data.frame(
  Site = c("ALT", "CAD", "ELL", "GRA", "OEN", "REC"),
  `Soil Type (WRB)` = c("Calcaric Cambisol", "Eutric Fluvisol", "Eutric Cambisol", "Calcaric Fluvisol", "Gleyic-calc. Cambisol", "Eutric Gleysol"),
  `Clay (%)` = c(22, 8, 33, 17, 37, 39),
  `Sand (%)` = c(48, 40, 31, 34, 32, 25),
  `Organic C (g/kg)` = c(21, 14, 23, 16, 24, 27),
  `pH (H2O)` = c(7.9, 6.3, 6.6, 8.3, 7.1, 7.4),
  check.names = FALSE
)

knitr::kable(sites_df_corrected)
```

Soil samples for this thesis were collected on [Your Sampling Date] from the topsoil layer (0-20 cm). [Add any further specific details about your sampling strategy here].

---

## Phosphorus Desorption Kinetics

The analysis of phosphorus (P) desorption kinetics was based on the principles of sequential extraction established by Flossmann and Richter (1982). The original method is described below, followed by the specific protocol adapted for this study.

### Original Method of Flossmann and Richter (1982)

The foundational method aims to characterize the P replenishment capacity of the soil. The procedure is as follows:

1.  **Removal of Soluble P**: 17.5 g of air-dried soil is shaken with 350 ml of deionized water for one hour at 25 ± 1°C. The suspension is centrifuged and the supernatant is decanted to remove the readily soluble P fraction. This first extract is referred to as:
    * **Solution A**: Contains easily soluble P, which is discarded.

2.  **Kinetic Extraction**: The remaining soil pellet is resuspended with another 350 ml of deionized water. Subsamples of the suspension are taken at specific time intervals, yielding the following extracts for kinetic analysis:
    * **Solution B**: Subsample taken after **10 minutes**.
    * **Solution C**: Subsample taken after **30 minutes**.
    * **Solution D**: Subsample taken after **120 minutes**.

3.  **Analysis**: The P concentration in Solutions B, C, and D is determined colorimetrically using the molybdenum blue method according to Murphy and Riley (1962).

### Adapted Kinetic Protocol for This Study

For this thesis, the original method was modified to capture the desorption process with a higher temporal resolution and using a different soil-to-solution ratio.

1.  **Soil Suspension**: 10 g of air-dried soil was suspended in 200 ml of deionized water. Unlike the original protocol, a pre-washing step to remove soluble P was not performed, meaning the measured desorption includes both the release of readily soluble P and the subsequent replenishment from the solid phase.

2.  **Kinetic Extraction**: The suspension was shaken continuously, and subsamples were taken at eight time points to generate a detailed kinetic curve. The resulting extracts were:
    * **Extract 1**: Subsample taken after **2 minutes**.
    * **Extract 2**: Subsample taken after **4 minutes**.
    * **Extract 3**: Subsample taken after **10 minutes**.
    * **Extract 4**: Subsample taken after **15 minutes**.
    * **Extract 5**: Subsample taken after **20 minutes**.
    * **Extract 6**: Subsample taken after **30 minutes**.
    * **Extract 7**: Subsample taken after **45 minutes**.
    * **Extract 8**: Subsample taken after **60 minutes**.

3.  **Analysis**: Each subsample was immediately filtered. The concentration of orthophosphate in the filtered extracts was determined colorimetrically using the **malachite green method**.

---

## Statistical Analysis

The statistical workflow involved two main stages: 1) estimating the P desorption kinetic parameters from the laboratory data, and 2) using these parameters to model the agronomic outcomes from the long-term field experiment.

### Modeling of Desorption Kinetics

To derive the kinetic parameters, a non-linear mixed-effects model (`nlme`) was implemented. This approach was chosen to simultaneously estimate the rate constant ($k$) and the maximum desorbable P ($P^S$) directly from the time-series data for each soil sample. The model was fitted to the exact solution of the first-order rate equation:

$$ P(t) = P^S \times (1 - e^{-k \times t'}) $$

Where $P(t)$ is the P concentration at time $t$, and $t'$ is an adjusted time ($t_\text{min} + 3$ min) to account for rapid initial P dissolution. The overall means for $P^S$ and $k$ were modeled as **fixed effects**, while sample-specific deviations for both parameters were modeled as **random effects** to capture the unique characteristics of each soil sample.

### Modeling of Agronomic Responses

The estimated kinetic parameters were merged with the agronomic and soil chemistry dataset from the years 2017-2022. A series of linear mixed-effects models were then constructed to evaluate the predictive power of these parameters.

#### Variables Used in the Models

The response and predictor variables used in the linear mixed-effects models are defined in the table below. Several predictors were log-transformed to improve linearity and meet model assumptions.

```{r}
#| label: tbl-variables
#| tbl-cap: "Description of response and predictor variables used in the agronomic models."

variables_df <- data.frame(
  Variable = c("`Y_norm`", "`annual_P_uptake`", "`annual_P_balance`", "`k`", "`PS`", "`kPS`", "`P_CO2`", "`P_AAE10`"),
  Role = c("Response", "Response", "Response", "Predictor", "Predictor", "Predictor", "Predictor", "Predictor"),
  Description = c(
    "Normalized crop yield, calculated as the plot yield divided by the site-specific median yield of the highest P treatment for that year and crop.",
    "Total phosphorus taken up by the harvested crop biomass over a growing season (kg P ha⁻¹).",
    "Net P budget, calculated as P inputs (fertilizer) minus P outputs (uptake by harvest) (kg P ha⁻¹).",
    "First-order rate constant of P desorption, representing the speed of P release (min⁻¹).",
    "Maximum desorbable P, representing the size of the readily available P pool (mg P L⁻¹).",
    "Product of `k` and `PS`, representing the initial flux of P from the soil.",
    "Plant-available P measured by the CO₂-saturated water extraction method (mg P kg⁻¹).",
    "Plant-available P measured by the ammonium-acetate-EDTA extraction method (mg P kg⁻¹)."
  )
)

knitr::kable(variables_df, col.names = c("Variable", "Role", "Description"))
```

#### Linear Mixed-Effects Model Structure

Linear mixed-effects models (`lmer`) were used to test the relationships between the predictor variables and each of the three response variables. The structure of these models was designed to account for the nested nature of the long-term experiment. A general form of the model is:

*Response Variable ~ Fixed Effects + (1 | Random Effects)*

* **Fixed Effects**: These represent the main explanatory variables of interest whose effects we wanted to quantify. The fixed effects included the kinetic parameters (`k`, `PS`, `kPS`) and the standard soil P tests (`P_CO2`, `P_AAE10`), along with their interactions.
* **Random Effects**: These were included to control for non-independence among observations. By including `(1 | Site)`, `(1 | Year)`, and `(1 | Crop)` as random intercepts, the model accounts for baseline differences in the response variable that are attributable to the specific location, growing season, or crop type, allowing for a more accurate estimation of the fixed effects.

To identify the most informative and parsimonious model, a systematic feature selection process was conducted using the `mlr3` machine learning framework. This involved training and evaluating different combinations of predictor variables using nested cross-validation to ensure the robustness of the final selected model.

All statistical analyses were performed in the R environment, utilizing the `nlme` package for kinetic modeling and the `lme4`, `lmerTest`, and `mlr3` packages for the final agronomic modeling and feature selection.