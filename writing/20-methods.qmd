# Materials and Methods {#sec-materials-and-methods}

## The Long-Term Phosphorus Fertilization Experiment {#sec-the-long-term-phosphorus-fertilization-experiment}

The soil samples for this thesis originate from a set of six long-term field trials in Switzerland, established by Agroscope between 1989 and 1992. The primary objective of these experiments was to validate and re-evaluate Swiss phosphorus (P) fertilization guidelines by assessing long-term crop yield responses to varying P inputs across different pedoclimatic conditions. A detailed description of the experimental design and site characteristics can be found in @hirteYieldResponseSoil2021.

The experiment was set up as a **completely randomized block design** with four field replications at each site. The core of the experiment consists of six fixed-plot treatments representing different P fertilization levels, which were applied annually as superphosphate before tillage and sowing. These levels were based on percentages of the officially recommended P inputs: 0% (Zero), 33% (Deficit), 67% (Reduced), 100% (Norm), 133% (Elevated), and 167% (Surplus).

## Experimental Sites {#sec-experimental-sites}

The six experimental sites are located in the main crop-growing regions of Switzerland: **Rümlang-Altwi (ALT)**, **Cadenazzo (CAD)**, **Ellighausen (ELL)**, **Grabs (GRA)**, **Oensingen (OEN)**, and **Zurich-Reckenholz (REC)**. The key soil properties are summarized below.

```{r}
#| label: tbl-sites-corrected
#| tbl-cap: "Soil characteristics of the six long-term experimental sites. Data adapted from Hirte et al. (2021)."

sites_df_corrected <- data.frame(
  Site = c("ALT", "CAD", "ELL", "GRA", "OEN", "REC"),
  `Soil Type (WRB)` = c("Calcaric Cambisol", "Eutric Fluvisol", "Eutric Cambisol", "Calcaric Fluvisol", "Gleyic-calc. Cambisol", "Eutric Gleysol"),
  `Clay (%)` = c(22, 8, 33, 17, 37, 39),
  `Sand (%)` = c(48, 40, 31, 34, 32, 25),
  `Organic C (g/kg)` = c(21, 14, 23, 16, 24, 27),
  `pH (H2O)` = c(7.9, 6.3, 6.6, 8.3, 7.1, 7.4),
  check.names = FALSE
)

knitr::kable(sites_df_corrected)
```

Soil samples for this thesis were collected in the year 2022 from the topsoil layer (0-20 cm).

------------------------------------------------------------------------

## Phosphorus Desorption Kinetics {#sec-phosphorus-desorption-kinetics}

The analysis of phosphorus (P) desorption kinetics was based on the principles of sequential extraction established by [@flossmannExtractionMethodCharacterizing1982]. The original method is described below, followed by the specific protocol adapted for this study.

### Original Method of Flossmann and Richter (1982)

The foundational method aims to characterize the P replenishment capacity of the soil. The procedure is as follows:

1.  **Removal of Soluble P**: 17.5 g of air-dried soil is shaken with 350 ml of deionized water for one hour at 120 Hz in a horizontal soil-shaker. The suspension is centrifuged at 4000 rpm for 15 minutes and the supernatant is decanted to remove the readily soluble P fraction.
2.  **Kinetic Extraction**: The remaining soil pellet is resuspended with another 350 ml of deionized water. Subsamples of the suspension are taken at specific time intervals (e.g., 10, 30, and 120 minutes).
3.  **Analysis**: The P concentration in the subsamples is determined colorimetrically.

### Adapted Kinetic Protocol for This Study {#sec-adapted-kinetic-protocol-for-this-study}

For this thesis, the original method was modified to capture the desorption process with a higher temporal resolution.

1.  **Pre-washing to Remove Soluble P**: A pre-washing step was performed to remove the readily soluble P fraction. 10 g of air-dried soil was suspended in 200 ml of deionized water and shaken for 60 minutes at 120 Hz. The suspension was then centrifuged for 15 minutes at 4000 rpm, and the supernatant containing the soluble P was discarded.

2.  **Kinetic Extraction**: The remaining soil pellet was resuspended in 200 ml of fresh deionized water. The suspension was shaken continuously, and subsamples were taken at eight time points to generate a detailed kinetic curve: **2, 4, 10, 15, 20, 30, 45, and 60 minutes**.

3.  **Analysis**: Each subsample was immediately filtered. The concentration of orthophosphate in the filtered extracts was determined colorimetrically using the **malachite green method** [@VanVeldhoven1987Malachite].

------------------------------------------------------------------------

## Statistical Analysis {#sec-statistical-analysis}

### Software and Statistical Environment

All data processing, statistical modeling, and visualization were conducted using the R programming language (v. 4.2.2) [@R-base]. The primary packages used for the analysis were: - `nlme` [@R-nlme] for fitting the non-linear mixed-effects models to the kinetic data. - `lme4` [@R-lme4] and `lmerTest` [@R-lmerTest] for fitting and testing the linear mixed-effects models for agronomic and soil property analyses. - `mlr3` [@R-mlr3] for the systematic feature selection and model validation workflow.

### Modeling of Desorption Kinetics {#sec-modeling-of-desorption-kinetics}

To derive the kinetic parameters, a non-linear mixed-effects model was implemented using the `nlme` package. This approach was chosen to simultaneously estimate the rate constant (*k*) and the maximum desorbable P ($P_{desorb}$) for each soil sample. The model was fitted to the exact solution of the first-order rate equation:

$$P(t) = P_{desorb} \times (1 - e^{-k \times t'})$$

Where $P(t)$ is the P concentration at time $t$, and $t'$ is an adjusted time ($t_{min}$ + 3 min) to account for the rapid initial dissolution of P that occurs before the first measurement. In this mixed-effects framework, the overall mean values for $P_{desorb}$ and *k* were modeled as **fixed effects**, while sample-specific deviations from these fixed effects were modeled as **random effects** to capture the unique desorption characteristics of each individual soil sample.

### Comparative Modeling of Soil and Agronomic Parameters

To test the hypotheses of this thesis, two distinct sets of linear mixed-effects models were constructed.

```{r}
#| label: tbl-variables
#| tbl-cap: "Description of variables used in the agronomic and soil models."

variables_df <- data.frame(
  Abbreviation = c("$Y_{rel}$", "$Y_{norm}$", "$P_{up}$", "$P_{bal}$", 
                   "$k$", "$P_{desorb}$", "$J_0$", 
                   "$P_{CO2}$", "$P_{AAE10}$",
                   "$Al_d$", "$Fe_d$"),
  `Full Name` = c("Relative Yield", "Normalized Yield", "P Uptake", "P Balance", 
                  "Rate Constant", "Desorbable P", "Initial P Flux", 
                  "Water-Soluble P", "Chelate-Extractable P",
                  "Dithionite-Extractable Al", "Dithionite-Extractable Fe"),
  Unit = c("unitless", "unitless", "kg P ha⁻¹", "kg P ha⁻¹",
           "min⁻¹", "mg P L⁻¹", "mg P L⁻¹ min⁻¹",
           "mg P kg⁻¹", "mg P kg⁻¹",
           "mg Al kg⁻¹", "mg Fe kg⁻¹"),
  Description = c(
    "Plot yield normalized by the national mean yield for that year and crop.",
    "Plot yield normalized by the site-specific median yield of the highest P treatment for that year and crop.",
    "Total P removed by the harvested crop biomass over a growing season.",
    "Net P budget, calculated as P inputs (fertilizer) minus P outputs (uptake).",
    "First-order rate constant of P desorption, representing the speed of P release.",
    "Maximum desorbable P, representing the size of the readily available P pool.",
    "Product of $k$ and $P_{desorb}$, representing the initial flux of P from the soil.",
    "Plant-available P measured by CO₂-saturated water extraction [@FAL1996Methodenbuch].",
    "Plant-available P measured by the ammonium-acetate-EDTA extraction method [@FAL1996Methodenbuch].",
    "Free Al oxides (crystalline and amorphous) extracted with dithionite-citrate-bicarbonate [@Mehra1960Iron].",
    "Free Fe oxides (crystalline and amorphous) extracted with dithionite-citrate-bicarbonate [@Mehra1960Iron]."
  )
)

knitr::kable(variables_df)
```

### Model Assumptions and Diagnostics

The validity of the linear mixed-effects models (`lmer`) relies on several key assumptions, primarily that the model residuals are normally distributed and homoscedastic (i.e., have constant variance across the range of predicted values). Prior to finalizing the models, these assumptions were rigorously checked through visual inspection of diagnostic plots, such as quantile-quantile (Q-Q) plots of the residuals and plots of residuals versus fitted values.

Initial exploratory data analysis revealed that several of the predictor variables, most notably the desorbable P pool ($P_{desorb}$ or PS), were strongly right-skewed. Using such variables directly in the linear models would violate the assumptions of linearity and homoscedasticity, leading to potentially biased and unreliable coefficient estimates.

To address this, various transformations (including square root and logarithmic) were tested on the skewed variables. The natural log-transformation (`log()`) was found to be the most effective at normalizing the distribution of `PS` and producing well-behaved model residuals that more closely met the required assumptions. Therefore, `log(PS)` was used as a fixed effect in all subsequent agronomic models to ensure the statistical validity of the results.

#### Models of P Availability Metrics as a Function of Soil Properties

First, to investigate the underlying soil-chemical drivers of the different P availability metrics (both kinetic and static), a series of models was built to predict each metric from key soil properties.

-   **Fixed Effects Structure:** The fixed effects were identical for all models in this category and included the primary soil physical and chemical properties: clay content, silt content, pH, organic carbon content, and dithionite-extractable iron ($Fe_d$) and aluminum ($Al_d$).
-   **Random Effects Structure:** The random effects structure accounted for the nested design of the STYCS experiment, with random intercepts for `year`, `Site`, `Site:block`, and `Site:Treatment`.

#### Comparative Models of Agronomic Outcomes

Second, the predictive power of the kinetic parameters was directly compared against that of the standard STP methods ("GRUD" system). For each agronomic response variable (Normalized Yield, P Uptake, and P Balance), two competing models were built. These models shared an identical random effects structure to ensure a fair comparison, differing only in their fixed effects.

-   **Random Effects Structure (for all agronomic models):** The structure `(1|year) + (1|Site) + (1|Site:block)` was used to control for variations due to the growing season, location, and in-field spatial differences.

-   **Model 1: The Kinetic Approach**

    -   **Fixed Effects:** This model used the kinetic parameters and their interaction: `k * log(PS)`. The interaction term tests the hypothesis that the benefit of a large desorbable P pool (`PS`) depends on the *rate* (`k`) at which it can be accessed.

-   **Model 2: The Standard STP (GRUD) Approach**

    -   **Fixed Effects:** This model used the two standard Swiss soil tests and their interaction: `P_CO2 * P_AAE10`.

The relative performance of these two sets of models was then evaluated to determine whether the kinetic parameters provided a significant improvement in predictive power for key agronomic outcomes. Further the relative performance of these two approaches, along with other combinations of predictor sets, was rigorously evaluated using a machine learning benchmark workflow implemented in the `mlr3` package [@R-mlr3]. The predictive power of each predictor set was quantified using **5-fold cross-validation**. Performance was measured as the percentage of explained variance on the hold-out data (1 - MSE / Var(y)), providing a robust and unbiased estimate of how well each model would generalize to new data. This benchmark allowed for a direct comparison of the information content provided by the kinetic parameters versus the standard soil tests for predicting key agronomic outcomes.
