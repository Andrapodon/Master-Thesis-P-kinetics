{
  "hash": "4fa83244428a101f715bd9878b8beed9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Pretest\"\nformat: \n  html:\n    math: mathjax\n  pdf: default\n  docx: default\nauthor: Marc Pérez\ndate: 2025-05-22\n---\n\n\n\n\n\n## Context\n\nTo explore, whether the proposed mechanisms and experiments to assess their dynamic, in a first step the Treatment levels $0P$ and $166P$ for all sites were analyzed. The experiments were conducted as displayed in the original paper of Flossmann & Richter with adjustments according to developments in technique and available equipment of the soil laboratory. Instead of the CAL-method, the Olsen-method was used to measure and estimate the quantity of P.\n\n## Model of P-release after Flossman & Richter\n$$\\frac{dP}{dt}=k\\times(P^S-P)$$\nThe constant $P^S$ denotes the amount of semi-labile P and was originally estimated as $P_\\text{Olsen}-P_{H_2O}$. Subsequently the DE is solved exactly, since the soil is as $t=0$ mixed with deionized water, it was assumed that $P(0)=0$\n\n## Exact Solution\n$$P(t)=P^{\\text{S}}-C\\times e^{-kt}$$\n\nfor $P(0)=P_0$ we receive:\n\n$$P(t)=P^S-(P^S-P_0)\\times e^{-kt}$$\n\nIf we set $P(0)=0$ we receive:\n\n$$P(t)=P^S\\times(1-e^{-kt})$$\n\n## Linearization\nNow we linearize the DE, so that a linear model can be employed to test the relation and estimate the parameters of interest:\n\n$$P(t)=P^S-(P^S-P_0)\\times e^{-kt}$$\n\n$$P(t)-P^S=-(P^S-P_0)\\times e^{-kt}$$\n\n$$P^S-P(t)=(P^S-P_0)\\times e^{-kt}$$\n\n$$1-\\frac{P(t)}{P^S}=(1-\\frac{P_0}{P^S})\\times e^{-kt}$$\n\nGiven $P_0=0$,\n\n$$log(1-\\frac{P(t)}{P^S})=-kt$$\n\n## Setup and preparation of dataset\n\n\n\n\n\n\n::: {.cell .hidden}\n\n```{.r .cell-code .hidden}\n#| include: false\n#| message: false\n#| warning: false\n\nRES <- list()\n\nlibrary(multcomp)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: mvtnorm\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: survival\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: TH.data\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: MASS\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'TH.data'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:MASS':\n\n    geyser\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| include: false\n#| message: false\n#| warning: false\n\nlibrary(car)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: carData\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| include: false\n#| message: false\n#| warning: false\n\nlibrary(tidyr)\nlibrary(lme4)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: Matrix\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'Matrix'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:tidyr':\n\n    expand, pack, unpack\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| include: false\n#| message: false\n#| warning: false\n\nlibrary(ggplot2)\nlibrary(ggtext)\nlibrary(ggpmisc)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading required package: ggpp\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nRegistered S3 methods overwritten by 'ggpp':\n  method                  from   \n  heightDetails.titleGrob ggplot2\n  widthDetails.titleGrob  ggplot2\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'ggpp'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:ggplot2':\n\n    annotate\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| include: false\n#| message: false\n#| warning: false\n\nlibrary(nlme)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'nlme'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:lme4':\n\n    lmList\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| include: false\n#| message: false\n#| warning: false\n\nlibrary(latex2exp)\nlibrary(kableExtra)\nlibrary(broom)\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:kableExtra':\n\n    group_rows\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:nlme':\n\n    collapse\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:car':\n\n    recode\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following object is masked from 'package:MASS':\n\n    select\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| include: false\n#| message: false\n#| warning: false\n\noptions(warn = -1)\n# Dataset preparation\nd <- read.csv(file = \"~/Documents/Master Thesis/Master-Thesis-P-kinetics/data/release-Data.csv\", na.strings = c(\"\", \"n.a.\"))\nd$Treatment <- d$Treatment |> factor()\nd$Pv.mg.L. <- as.numeric(d$Pv.mg.L.)\nd$Pv_labile.mg.L. <- as.numeric(d$Pv_labile.mg.L.)\nd$Pv_Olsen.mg.L. <- as.numeric(d$Pv_Olsen.mg.L.)\nd$uid <- paste(d$Site, d$Treatment, as.character(d$Repetition), sep=\"_\")\nd$Repetition <- as.factor(d$Repetition)\nd$flos <- as.numeric(d$Pv_Olsen.mg.L.)-as.numeric(d$Pv_labile.mg.L.)\nd$flos[d$flos <= 0] <- quantile(d$flos[d$flos > 0], 0.025, na.rm=TRUE)/2\nd$Y1 <- log(1 - d$Pv.mg.L. / d$flos) # one timeseries removed, since flos too low\nd$Y1[is.nan(d$Y1)] <- NA\n\nstr(d)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n'data.frame':\t394 obs. of  20 variables:\n $ Site              : chr  \"Cadenazzo\" \"Cadenazzo\" \"Cadenazzo\" \"Cadenazzo\" ...\n $ Treatment         : Factor w/ 3 levels \"P0\",\"P100\",\"P166\": 1 1 1 1 1 1 1 1 1 1 ...\n $ Repetition        : Factor w/ 4 levels \"1\",\"2\",\"3\",\"4\": 2 2 2 2 2 2 1 1 1 1 ...\n $ Nummer            : num  1 1 1 1 1 1 2 2 2 2 ...\n $ mSoil_Olsen.g.    : chr  \"10.05\" \"10.05\" \"10.05\" \"10.05\" ...\n $ mSoil_H2O.g.      : num  10.3 10.3 10.3 10.3 10.3 ...\n $ Abs_labile.1.     : chr  \"0.26\" \"0.26\" \"0.26\" \"0.26\" ...\n $ Abs_Olsen.1.      : chr  \"1.02\" \"1.02\" \"1.02\" \"1.02\" ...\n $ Abs_Olsen1_10.1.  : chr  \"0.28\" \"0.28\" \"0.28\" \"0.28\" ...\n $ t.min.            : num  5 10 20 30 45 60 5 10 20 30 ...\n $ Abs.1.            : num  0.21 0.22 0.23 0.24 0.26 0.25 0.22 0.24 0.25 0.27 ...\n $ Pv_labile.mg.L.   : num  0.05 0.05 0.05 0.05 0.05 0.05 0.06 0.06 0.06 0.06 ...\n $ Pv_Olsen.mg.L.    : num  0.35 0.35 0.35 0.35 0.35 0.35 0.42 0.42 0.42 0.42 ...\n $ Pv_Olsen1_10.mg.L.: chr  \"0.46\" \"0.46\" \"0.46\" \"0.46\" ...\n $ Pv.mg.L.          : num  0.03 0.04 0.04 0.05 0.05 0.05 0.04 0.05 0.05 0.06 ...\n $ Dilution.1.       : num  20 20 20 20 20 20 20 20 20 20 ...\n $ V_H2O.L.          : num  0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 ...\n $ uid               : chr  \"Cadenazzo_P0_2\" \"Cadenazzo_P0_2\" \"Cadenazzo_P0_2\" \"Cadenazzo_P0_2\" ...\n $ flos              : num  0.3 0.3 0.3 0.3 0.3 0.3 0.36 0.36 0.36 0.36 ...\n $ Y1                : num  -0.105 -0.143 -0.143 -0.182 -0.182 ...\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| include: false\n#| message: false\n#| warning: false\n\n#> data.frame:\t353 obs. of  21 variables:\n#>  $ Site              : chr  \"Cadenazzo\" \"Cadenazzo\" \"Cadenazzo\" \"Cadenazzo\" ...\n#>  $ Treatment         : Factor w/ 3 levels \"0P\",\"100P\",\"166P\": 1 1 1 1 1 1 1 1 1 1 ...\n#>  $ Repetition        : Factor w/ 4 levels \"1\",\"2\",\"3\",\"4\": 2 2 2 2 2 2 1 1 1 1 ...\n#>  $ Nummer            : num  1 1 1 1 1 1 2 2 2 2 ...\n#>  $ mSoil_Olsen.g.    : chr  \"10.05\" \"10.05\" \"10.05\" \"10.05\" ...\n#>  $ mSoil_H2O.g.      : num  10.3 10.3 10.3 10.3 10.3 ...\n#>  $ Abs_labile.1.     : chr  \"0.26\" \"0.26\" \"0.26\" \"0.26\" ...\n#>  $ Abs_Olsen.1.      : chr  \"1.02\" \"1.02\" \"1.02\" \"1.02\" ...\n#>  $ Abs_Olsen1_10.1.  : chr  \"0.28\" \"0.28\" \"0.28\" \"0.28\" ...\n#>  $ t.min.            : num  5 10 20 30 45 60 5 10 20 30 ...\n#>  $ Abs.1.            : num  0.21 0.22 0.23 0.24 0.26 0.25 0.22 0.24 0.25 0.27 ...\n#>  $ Pv_labile.mg.L.   : num  0.05 0.05 0.05 0.05 0.05 0.05 0.06 0.06 0.06 0.06 ...\n#>  $ Pv_Olsen.mg.L.    : num  0.35 0.35 0.35 0.35 0.35 0.35 0.42 0.42 0.42 0.42 ...\n#>  $ Pv_Olsen1_10.mg.L.: chr  \"0.46\" \"0.46\" \"0.46\" \"0.46\" ...\n#>  $ Pv.mg.L.          : num  0.03 0.04 0.04 0.05 0.05 0.05 0.04 0.05 0.05 0.06 ...\n#>  $ Dilution.1.       : num  20 20 20 20 20 20 20 20 20 20 ...\n#>  $ V_H2O.L.          : num  0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 0.2 ...\n#>  $ uid               : chr  \"Cadenazzo_0P_2\" \"Cadenazzo_0P_2\" \"Cadenazzo_0P_2\" \"Cadenazzo_0P_2\" ...\n#>  $ flos              : num  0.3 0.3 0.3 0.3 0.3 0.3 0.36 0.36 0.36 0.36 ...\n#>  $ Y1                : num  -0.105 -0.143 -0.143 -0.182 -0.182 ...\n#>  $ nls_pred          : num  0.0283 0.04 0.0468 0.048 0.0482 ...\n#>   ..- attr(*, \"label\")= chr \"Fitted values\"\n```\n:::\n\n\n\n\n\nNow we can see, whether our linearized model displays a linear relation.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| echo: false\n#| warning: false\n#| message: false\nres <- lmList(Y1 ~ t.min. | uid, d,na.action = na.pass)\nsummary(res)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\n  Model: Y1 ~ t.min. | uid \n   Data: d \n\nCoefficients:\n   (Intercept) \n                      Estimate Std. Error    t value     Pr(>|t|)\nCadenazzo_P0_1     -0.12891945 0.01537006  -8.387702 4.332766e-12\nCadenazzo_P0_2     -0.12037045 0.01537006  -7.831491 4.433395e-11\nCadenazzo_P0_3              NA         NA         NA           NA\nCadenazzo_P0_4              NA         NA         NA           NA\nCadenazzo_P100_1            NA         NA         NA           NA\nCadenazzo_P100_2            NA         NA         NA           NA\nCadenazzo_P100_3            NA         NA         NA           NA\nCadenazzo_P100_4            NA         NA         NA           NA\nCadenazzo_P166_1   -0.26932199 0.01537006 -17.522512 6.499702e-27\nCadenazzo_P166_2   -0.19243796 0.01537006 -12.520316 2.550625e-19\nCadenazzo_P166_3            NA         NA         NA           NA\nCadenazzo_P166_4            NA         NA         NA           NA\nEllighausen_P0_1   -0.10464296 0.01537006  -6.808236 3.136905e-09\nEllighausen_P0_2   -0.11438112 0.01537006  -7.441815 2.257472e-10\nEllighausen_P0_3            NA         NA         NA           NA\nEllighausen_P0_4            NA         NA         NA           NA\nEllighausen_P100_1          NA         NA         NA           NA\nEllighausen_P100_2          NA         NA         NA           NA\nEllighausen_P100_3          NA         NA         NA           NA\nEllighausen_P100_4          NA         NA         NA           NA\nEllighausen_P166_1          NA         NA         NA           NA\nEllighausen_P166_3          NA         NA         NA           NA\nEllighausen_P166_4          NA         NA         NA           NA\nOensingen_P0_1     -0.03432646 0.01537006  -2.233333 2.882091e-02\nOensingen_P0_2     -0.05745952 0.01537006  -3.738407 3.819350e-04\nOensingen_P0_3              NA         NA         NA           NA\nOensingen_P0_4              NA         NA         NA           NA\nOensingen_P100_1            NA         NA         NA           NA\nOensingen_P100_2            NA         NA         NA           NA\nOensingen_P100_3            NA         NA         NA           NA\nOensingen_P100_4            NA         NA         NA           NA\nOensingen_P166_1   -0.13275856 0.01537006  -8.637481 1.527196e-12\nOensingen_P166_2   -0.17051390 0.01537006 -11.093902 6.616653e-17\nOensingen_P166_3            NA         NA         NA           NA\nOensingen_P166_4            NA         NA         NA           NA\nReckenholz_P0_1    -0.10545869 0.01537006  -6.861308 2.519112e-09\nReckenholz_P0_2    -0.08557888 0.01537006  -5.567897 4.753375e-07\nReckenholz_P0_3             NA         NA         NA           NA\nReckenholz_P0_4             NA         NA         NA           NA\nReckenholz_P100_1           NA         NA         NA           NA\nReckenholz_P100_2           NA         NA         NA           NA\nReckenholz_P100_3           NA         NA         NA           NA\nReckenholz_P100_4           NA         NA         NA           NA\nReckenholz_P166_1  -0.17172348 0.01537006 -11.172600 4.839473e-17\nReckenholz_P166_2  -0.23296391 0.01537006 -15.156998 1.712692e-23\nReckenholz_P166_3           NA         NA         NA           NA\nReckenholz_P166_4           NA         NA         NA           NA\nRuemlang_P0_1      -0.01851905 0.01537006  -1.204878 2.324269e-01\nRuemlang_P0_2      -0.08675331 0.01537006  -5.644307 3.515958e-07\nRuemlang_P0_3               NA         NA         NA           NA\nRuemlang_P0_4               NA         NA         NA           NA\nRuemlang_P100_1             NA         NA         NA           NA\nRuemlang_P100_2             NA         NA         NA           NA\nRuemlang_P100_3             NA         NA         NA           NA\nRuemlang_P100_4             NA         NA         NA           NA\nRuemlang_P166_1    -0.26153690 0.01537006 -17.016002 3.315417e-26\nRuemlang_P166_2             NA         NA         NA           NA\nRuemlang_P166_3             NA         NA         NA           NA\nRuemlang_P166_4             NA         NA         NA           NA\n   t.min. \n                        Estimate   Std. Error       t value     Pr(>|t|)\nCadenazzo_P0_1     -1.318800e-03 0.0004483906 -2.941186e+00 4.466020e-03\nCadenazzo_P0_2     -1.272378e-03 0.0004483906 -2.837654e+00 5.984783e-03\nCadenazzo_P0_3                NA           NA            NA           NA\nCadenazzo_P0_4                NA           NA            NA           NA\nCadenazzo_P100_1              NA           NA            NA           NA\nCadenazzo_P100_2              NA           NA            NA           NA\nCadenazzo_P100_3              NA           NA            NA           NA\nCadenazzo_P100_4              NA           NA            NA           NA\nCadenazzo_P166_1   -5.270369e-03 0.0004483906 -1.175397e+01 4.905164e-18\nCadenazzo_P166_2   -3.394812e-03 0.0004483906 -7.571105e+00 1.316077e-10\nCadenazzo_P166_3              NA           NA            NA           NA\nCadenazzo_P166_4              NA           NA            NA           NA\nEllighausen_P0_1    4.952586e-05 0.0004483906  1.104525e-01 9.123759e-01\nEllighausen_P0_2   -1.260933e-04 0.0004483906 -2.812130e-01 7.794010e-01\nEllighausen_P0_3              NA           NA            NA           NA\nEllighausen_P0_4              NA           NA            NA           NA\nEllighausen_P100_1            NA           NA            NA           NA\nEllighausen_P100_2            NA           NA            NA           NA\nEllighausen_P100_3            NA           NA            NA           NA\nEllighausen_P100_4            NA           NA            NA           NA\nEllighausen_P166_1            NA           NA            NA           NA\nEllighausen_P166_3            NA           NA            NA           NA\nEllighausen_P166_4            NA           NA            NA           NA\nOensingen_P0_1      1.049070e-04 0.0004483906  2.339634e-01 8.157164e-01\nOensingen_P0_2     -1.837559e-04 0.0004483906 -4.098121e-01 6.832320e-01\nOensingen_P0_3                NA           NA            NA           NA\nOensingen_P0_4                NA           NA            NA           NA\nOensingen_P100_1              NA           NA            NA           NA\nOensingen_P100_2              NA           NA            NA           NA\nOensingen_P100_3              NA           NA            NA           NA\nOensingen_P100_4              NA           NA            NA           NA\nOensingen_P166_1   -2.320568e-04 0.0004483906 -5.175327e-01 6.064639e-01\nOensingen_P166_2   -5.531502e-04 0.0004483906 -1.233635e+00 2.215861e-01\nOensingen_P166_3              NA           NA            NA           NA\nOensingen_P166_4              NA           NA            NA           NA\nReckenholz_P0_1     2.780943e-04 0.0004483906  6.202053e-01 5.371956e-01\nReckenholz_P0_2    -7.752286e-04 0.0004483906 -1.728914e+00 8.836252e-02\nReckenholz_P0_3               NA           NA            NA           NA\nReckenholz_P0_4               NA           NA            NA           NA\nReckenholz_P100_1             NA           NA            NA           NA\nReckenholz_P100_2             NA           NA            NA           NA\nReckenholz_P100_3             NA           NA            NA           NA\nReckenholz_P100_4             NA           NA            NA           NA\nReckenholz_P166_1  -1.609218e-03 0.0004483906 -3.588876e+00 6.216266e-04\nReckenholz_P166_2  -4.831330e-03 0.0004483906 -1.077482e+01 2.367928e-16\nReckenholz_P166_3             NA           NA            NA           NA\nReckenholz_P166_4             NA           NA            NA           NA\nRuemlang_P0_1       8.878899e-20 0.0004483906  1.980171e-16 1.000000e+00\nRuemlang_P0_2      -1.438957e-03 0.0004483906 -3.209160e+00 2.032261e-03\nRuemlang_P0_3                 NA           NA            NA           NA\nRuemlang_P0_4                 NA           NA            NA           NA\nRuemlang_P100_1               NA           NA            NA           NA\nRuemlang_P100_2               NA           NA            NA           NA\nRuemlang_P100_3               NA           NA            NA           NA\nRuemlang_P100_4               NA           NA            NA           NA\nRuemlang_P166_1    -1.090605e-03 0.0004483906 -2.432266e+00 1.764226e-02\nRuemlang_P166_2               NA           NA            NA           NA\nRuemlang_P166_3               NA           NA            NA           NA\nRuemlang_P166_4               NA           NA            NA           NA\n\nResidual standard error: 0.02119011 on 68 degrees of freedom\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| echo: false\n#| warning: false\n#| message: false\nggplot(d, aes(y=Y1, x=t.min., col = Repetition)) +\n  geom_point() +\n  facet_grid(Site ~ Treatment) + \n  labs(x=TeX(\"$Time (min)$\"),\n       y=TeX(\"$ln(1-\\\\frac{P}{P_S})$\")) +\n  geom_smooth(method=\"lm\", alpha = 0.3) \n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](pretest_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n\n\n\nIf the parameter for the plateau could be estimated directly by using a non-linear non-least-squares model, we could omit the Olsen-measurement in the future.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#| echo: true\n#| warning: false\n#| message: false\n\nRes <- nlsList(Pv.mg.L. ~ PS * (1 - exp(-k * t.min.)) | uid, d[, c(\"Pv.mg.L.\", \"uid\", \"t.min.\")],  start=list(PS=0.1,k=0.2))\n# summary(Res)\n# d$nls_pred <- predict(Res)\n\n# Extract coefficients from the nlsList results\nnls_coefs <- coef(Res)\nnls_coefs$uid <- rownames(nls_coefs)\n\n# Merge coefficients back to the main dataset\nd_plot <- merge(d, nls_coefs, by = \"uid\")\n\n# Most straightforward approach - create curves manually\ntime_seq <- seq(min(d$t.min., na.rm = TRUE), max(d$t.min., na.rm = TRUE), length.out = 100)\n\n# Create prediction data\npred_data <- d_plot %>%\n  select(uid, Site, Treatment, Repetition, PS, k) %>%\n  distinct() %>%\n  crossing(t.min. = time_seq) %>%\n  mutate(pred_Pv = PS * (1 - exp(-k * t.min.)))\n\n# Final plot\np1 <- ggplot() +\n  geom_point(data = d_plot, aes(y = Pv.mg.L., x = t.min., col = Repetition)) +\n  geom_line(data = pred_data, aes(x = t.min., y = pred_Pv, col = Repetition), size = 0.5) +\n  facet_grid(Treatment ~ Site) +\n  labs(x = TeX(\"$Time (min)$\"),\n       y = TeX(\"$P_{V}(\\\\frac{mg}{L})$\")); suppressWarnings(print(p1))\n```\n\n::: {.cell-output-display}\n![](pretest_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#| echo: true\n#| warning: false\n#| message: false\n\nd$ui <- interaction(d$Site, d$Treatment)\n\nnlme.coef.avg <- list()\nnlme.coef <- list()\nfor (lvl in levels(d$ui)){\n  d.tmp <- subset(d, ui == lvl)\n  # first get nlsList coefs for comparison only (unused)\n  temp_nls <- coef(nlsList(Pv.mg.L. ~ PS * (1 - exp(-k * t.min.)) | uid, \n                    d.tmp[, c(\"Pv.mg.L.\", \"uid\", \"t.min.\")], \n                    start = list(PS = 0.1, k = 0.2)))\n  nlsList_coefs <- c(apply(temp_nls, 2, \\(x) c(mean=mean(x), sd=sd(x))))\n  names(nlsList_coefs) <- c(\"PS.mean\", \"PS.sd\", \"k.mean\", \"k.sd\")\n\n  # now do the real thing\n  model4 <- nlme(Pv.mg.L. ~ PS * (1 - exp(-k * t.min.)),\n                fixed = PS + k ~ 1,\n                random = PS + k ~ 1 | uid,\n                data = d.tmp[, c(\"Pv.mg.L.\", \"uid\", \"t.min.\")],\n                start = c(PS = 0.1, k = 0.2))\n  coef(model4)\n  fixef <- model4$coefficients$fixed\n  ranefs <- ranef(model4)\n  colnames(ranefs) <- paste0(\"ranef_\",colnames(ranefs))\n  nlme.coef[[lvl]]  <- cbind(coef(model4), ranefs, Rep=1:nrow(ranef(model4)), ui=lvl, Site=d.tmp[1, \"Site\"], Treatment=d.tmp[1, \"Treatment\"], uid = rownames(coef(model4)))\n  nlme.coef.avg[[lvl]] <- data.frame(PS=fixef[\"PS\"], k=fixef[\"k\"], ui=lvl, Site=d.tmp[1, \"Site\"], Treatment=d.tmp[1, \"Treatment\"], uid = d.tmp$uid)\n}\n\nnlme.coef.avg <- do.call(rbind, nlme.coef.avg)\n# folgendes datenset wollen wir benutzen um ihn mit dem Boden zu kombinieren\nnlme.coef <- do.call(rbind, nlme.coef)\n```\n:::\n\n\n\n\n\n\nLG: hier machen wir folgendes:\n\n1. Visualisiere Daten\n2. for k*PS use sqrt-scale\n3. Erkenne, dass keine offenslichtichen verletzuungen für ein lineares modell vorhanden sind\n4. fitte ordinary linear squares model, with Treatment as the factor of interest and Site as covariate (analougous to paired t-test and equivalent to anova with Site as block factor)\n5. Perform a classical Type II anova (using the car::Anova function)\n6. Perform (post-hoc) TukeyHSD test (using multcomp package)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nggplot(nlme.coef, aes(y=PS  , x=Treatment, col=Site)) + geom_boxplot()#+ geom_line(aes(group=Site))\n```\n\n::: {.cell-output-display}\n![](pretest_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\nggplot(nlme.coef, aes(y=k   , x=Treatment, col=Site)) + geom_boxplot() #+ geom_line(aes(group=Site))\n```\n\n::: {.cell-output-display}\n![](pretest_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\nggplot(nlme.coef, aes(y=k*PS, x=Treatment, col=Site)) + geom_boxplot() + scale_y_sqrt()#+ geom_line(aes(group=Site)) \n```\n\n::: {.cell-output-display}\n![](pretest_files/figure-html/unnamed-chunk-3-3.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\nggplot(nlme.coef, aes(y=PS  , x=Site, col=Treatment)) + geom_boxplot() #+ geom_line(aes(group=Site))\n```\n\n::: {.cell-output-display}\n![](pretest_files/figure-html/unnamed-chunk-3-4.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\nggplot(nlme.coef, aes(y=k   , x=Site, col=Treatment)) + geom_boxplot() #+ geom_line(aes(group=Site))\n```\n\n::: {.cell-output-display}\n![](pretest_files/figure-html/unnamed-chunk-3-5.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\nggplot(nlme.coef, aes(y=k*PS, x=Site, col=Treatment)) + geom_boxplot() + scale_y_sqrt()#+ geom_line(aes(group=Site)) \n```\n\n::: {.cell-output-display}\n![](pretest_files/figure-html/unnamed-chunk-3-6.png){width=672}\n:::\n\n```{.r .cell-code .hidden}\nfit.PS   <- lm(PS            ~ Treatment + Site, nlme.coef)\nfit.k    <- lm(k             ~ Treatment + Site, nlme.coef)\nfit.kPS  <- lm(I(sqrt(k*PS)) ~ Treatment + Site, nlme.coef)\n\nAnova(fit.PS)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnova Table (Type II tests)\n\nResponse: PS\n            Sum Sq Df  F value    Pr(>F)    \nTreatment 0.313297  2 105.7251 < 2.2e-16 ***\nSite      0.035346  4   5.9639 0.0005002 ***\nResiduals 0.077046 52                       \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nsummary(glht(fit.PS, mcp(Treatment = \"Tukey\")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\t Simultaneous Tests for General Linear Hypotheses\n\nMultiple Comparisons of Means: Tukey Contrasts\n\n\nFit: lm(formula = PS ~ Treatment + Site, data = nlme.coef)\n\nLinear Hypotheses:\n                 Estimate Std. Error t value Pr(>|t|)    \nP100 - P0 == 0    0.06105    0.01217   5.016  2.2e-05 ***\nP166 - P0 == 0    0.17710    0.01234  14.348  < 1e-05 ***\nP166 - P100 == 0  0.11604    0.01234   9.401  < 1e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n(Adjusted p values reported -- single-step method)\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n# Fazit: PS wird von treatment stark beeinfluss, k eher nicht (dafür von site)\nAnova(fit.k)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnova Table (Type II tests)\n\nResponse: k\n           Sum Sq Df F value    Pr(>F)    \nTreatment 0.14807  2  5.1204  0.009336 ** \nSite      0.51961  4  8.9843 1.358e-05 ***\nResiduals 0.75187 52                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nsummary(glht(fit.k, mcp(Treatment = \"Tukey\")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\t Simultaneous Tests for General Linear Hypotheses\n\nMultiple Comparisons of Means: Tukey Contrasts\n\n\nFit: lm(formula = k ~ Treatment + Site, data = nlme.coef)\n\nLinear Hypotheses:\n                 Estimate Std. Error t value Pr(>|t|)   \nP100 - P0 == 0    0.08838    0.03802   2.324  0.06124 . \nP166 - P0 == 0   -0.02961    0.03856  -0.768  0.72423   \nP166 - P100 == 0 -0.11798    0.03856  -3.060  0.00959 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n(Adjusted p values reported -- single-step method)\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nAnova(fit.kPS)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnova Table (Type II tests)\n\nResponse: I(sqrt(k * PS))\n            Sum Sq Df F value   Pr(>F)    \nTreatment 0.186813  2 42.4144 1.19e-11 ***\nSite      0.047097  4  5.3465 0.001105 ** \nResiduals 0.114516 52                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nsummary(glht(fit.kPS, mcp(Treatment = \"Tukey\")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\t Simultaneous Tests for General Linear Hypotheses\n\nMultiple Comparisons of Means: Tukey Contrasts\n\n\nFit: lm(formula = I(sqrt(k * PS)) ~ Treatment + Site, data = nlme.coef)\n\nLinear Hypotheses:\n                 Estimate Std. Error t value Pr(>|t|)    \nP100 - P0 == 0    0.08750    0.01484   5.896  < 0.001 ***\nP166 - P0 == 0    0.13638    0.01505   9.063  < 0.001 ***\nP166 - P100 == 0  0.04888    0.01505   3.248  0.00574 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n(Adjusted p values reported -- single-step method)\n```\n\n\n:::\n:::\n\n\n\n\n\nResults:\n\n1. for PS Treatment explains a lot, and site not so much. c.f. plot for a monotonous relationship\n2. for k, the Treatment seems to be little relevant\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# new Data set, that gives info about Soil\nallP <- readRDS(\"~/Documents/Master Thesis/Master-Thesis-P-kinetics/data/all_P.rds\")\nallP$rep <- allP$rep %>% as.roman() %>% as.integer()\nallP$uid <- paste(allP$location,allP$treatment_ID,as.character(allP$rep),sep = \"_\")\n\n# 1. merge this with nlme.coef\nnlme.coef <- merge(nlme.coef,allP[allP$year==2018,],by = \"uid\")\n\nRES$nlme.coef <- nlme.coef\nRES$nlme.coef.avg <- nlme.coef.avg\nRES$data <- d\nsaveRDS(RES, file = \"~/Documents/Master Thesis/Master-Thesis-P-kinetics/data/RES.rds\")\n```\n:::\n",
    "supporting": [
      "pretest_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}